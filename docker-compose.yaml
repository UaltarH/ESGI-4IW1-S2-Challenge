version: '3'

services:
  mongo:
    container_name: ${MONGO_CONTAINER_NAME:-app_mongo}
    image: mongo
    ports:
      - 127.0.0.1:27017:27017
    volumes:
      - mongo-data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
    working_dir: /SampleCollections

  node:
    container_name: ${NODE_CONTAINER_NAME:-app_node}
    image: node:latest
    environment:
       PORT: 3000
       MONGO_URL: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/app?authSource=admin
       DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
       JWT_SECRET: $(JWT_SECRET)
    ports:
      - 8000:8000
    volumes:
      - ./backend:/home/node/
    working_dir: /home/node/
    entrypoint: sh -c
    command: '"npm install && npm run dev"'
    depends_on:
      - postgres
      - mongo
  
  vuejs:
   container_name: ${VUEJS_CONTAINER_NAME:-app_vuejs}
   image: node:20.0.0-alpine
   user: node
   working_dir: /home/node
   # le --port 5174 --host est pour que le serveur soit accessible depuis l'extérieur et ce sont des paramètres passés à vite parce que npm run dev exécute vite
   command: '"cd frontend && npm install && npm run dev"'
   ports:
     - 5173:5173
   volumes:
      - .:/home/node
   entrypoint: sh -c

  postgres:
    container_name: ${POSTGRES_CONTAINER_NAME:-app_postgres}
    image: postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    
  adminer:
    container_name: ${ADMINER_CONTAINER_NAME:-app_adminer}
    image: adminer
    ports:
      - 8080:8080
    depends_on:
      - postgres
  
  mongo-express:
    container_name: ${MONGO_EXPRESS_CONTAINER_NAME:-app_mongo_express}
    image: mongo-express:1.0.2-20-alpine3.19
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_SERVER: mongo
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    depends_on:
      - mongo

volumes:
  mongo-data: {}
  postgres-data: {}
